{"version":3,"file":"api.js","sources":["../src/utils/console.ts","../src/utils/transform.ts","../src/jsonp.ts","../src/ajax.ts","../src/constant.ts","../src/entity.ts","../src/index.ts"],"sourcesContent":["\r\nconst hasConsole = (): boolean => typeof console !== 'undefined'\r\n\r\nexport function warn(...arg: any[]): void {\r\n  if (hasConsole()) console.warn(...arg)\r\n}\r\n\r\nexport function log(...arg: any[]): void {\r\n  if (hasConsole()) console.log(...arg)\r\n}\r\n\r\nexport function error(...arg: any[]): void {\r\n  if (hasConsole()) console.error(...arg)\r\n}\r\n","import { GlobalObject } from '../type'\r\n\r\nexport function obj2formData(obj: GlobalObject): FormData {\r\n  let data = new FormData()\r\n  Object.keys(obj).forEach(key => data.append(key, obj[key]))\r\n  return data\r\n}\r\n\r\nexport const copyProp = (o: object, t: object): void => Object.keys(o).forEach(e => t[e] = o[e])\r\n\r\nexport const Obj2QueryString = (o: GlobalObject): string => Object.keys(o).map(e => e + '=' + o[e]).join('&')\r\n\r\nexport const queryStringMark = (url) => /\\?/.test(url) ? '&' : '?'\r\n","import { error } from './utils/console'\r\nimport { queryStringMark } from './utils/transform'\r\nconst $head = document.getElementsByTagName('head')[0]\r\n\r\nfunction generateCallbackID() {\r\n  return `jsonp_${Date.now()}_${Math.ceil(Math.random() * 100000)}`\r\n}\r\n\r\nfunction clearJsonp(id) {\r\n  window[id] = undefined\r\n}\r\n\r\nfunction removeScript(id) {\r\n  $head.removeChild(document.getElementById(id))\r\n}\r\n\r\nfunction injectScript(id, src) {\r\n  const script = document.createElement('script')\r\n  script.id = id\r\n  script.setAttribute('src', src)\r\n  $head.appendChild(script)\r\n}\r\n\r\n/**\r\n * Create jsonp\r\n *\r\n * @param href The link\r\n * @param timeout The timeout\r\n * @param callbackName The jsonp callback name, append to href\r\n * @param callbackId The jsonp callback ID\r\n * @returns a Promise which should include response\r\n */\r\nexport default function createJsonp({ href, timeout, callbackName, callbackId: id = generateCallbackID() }) {\r\n  let src = `${href}${queryStringMark(href)}${callbackName}=${id}`\r\n\r\n  return new Promise((resolve, reject) => {\r\n    let timeoutId = setTimeout(() => {\r\n      error(`JSONP request to ${src} timed out`)\r\n      reject(src)\r\n      clearJsonp(id)\r\n      removeScript(id)\r\n    }, timeout)\r\n\r\n    window[id] = res => {\r\n      resolve(res)\r\n      clearTimeout(timeoutId)\r\n      clearJsonp(id)\r\n      removeScript(id)\r\n    }\r\n\r\n    injectScript(id, src)\r\n  })\r\n}\r\n","import { obj2formData } from './utils/transform'\r\n\r\nfunction setHeaders(xhr, headerList) {\r\n  for (let key in headerList) {\r\n    xhr.setRequestHeader(key, headerList[key])\r\n  }\r\n}\r\n\r\nfunction bindEvents(xhr, eventList) {\r\n  Object.keys(eventList).forEach(event => {\r\n    xhr.addEventListener(event, eventList[event])\r\n  })\r\n  if (typeof eventList.uploadProgress === 'function' && xhr.upload) {\r\n    xhr.upload.addEventListener('progress', eventList.uploadProgress)\r\n  }\r\n}\r\n\r\nfunction parseResponse(res) {\r\n  if (typeof res === 'string' && res.length) {\r\n    try {\r\n      return JSON.parse(res)\r\n    } catch (e) {\r\n      return res\r\n    }\r\n  }\r\n  return null\r\n}\r\n\r\nfunction createAjax({\r\n  url,\r\n  search,\r\n  input,\r\n  dataType,\r\n  methods,\r\n  async,\r\n  withCredentials,\r\n  header,\r\n  timeout,\r\n  xhrEvent\r\n}) {\r\n  const xhr = new XMLHttpRequest()\r\n  return new Promise((resolve, reject) => {\r\n    let data = dataType === 'json' ? search.slice(1) : obj2formData(input)\r\n    xhr.withCredentials = withCredentials\r\n    xhr.timeout = timeout\r\n    xhr.onreadystatechange = () => {\r\n      if (xhr.readyState === 4) {\r\n        if (xhr.status === 200) {\r\n          resolve(parseResponse(xhr.response))\r\n        } else {\r\n          reject(xhr)\r\n        }\r\n      }\r\n    }\r\n    xhr.open(methods, url, async)\r\n    setHeaders(xhr, header)\r\n    xhr.send(data)\r\n    bindEvents(xhr, xhrEvent)\r\n\r\n  })\r\n}\r\n\r\nexport default createAjax\r\n","import { EntityOption } from './type'\r\n\r\n// https://github.com/axios/axios/blob/master/lib/helpers/isAbsoluteURL.js\r\nexport const REGEXP_URL = /^([a-z][a-z\\d\\+\\-\\.]*:)?\\/\\//i\r\n\r\nexport const DEFAULT_OPTIONS: EntityOption = {\r\n  domain: window.location.href,\r\n  methods: 'GET',\r\n  dataType: 'json',\r\n  timeout: 10000,\r\n  useMock: false,\r\n  input: {},\r\n  mock: {},\r\n  callbackName: 'callback',\r\n  callbackId: undefined,\r\n  withCredentials: false,\r\n  urlModel: 0,\r\n  debug: false,\r\n  async: true,\r\n  filter: n => n,\r\n  header: {},\r\n  xhrEvent: {}\r\n}\r\n","import { copyProp, Obj2QueryString, queryStringMark } from './utils/transform'\r\nimport { log } from './utils/console'\r\nimport createJsonp from './jsonp'\r\nimport ajax from './ajax'\r\nimport { REGEXP_URL } from './constant'\r\nimport { IEntity } from './type'\r\n\r\nexport default class Entity implements IEntity {\r\n  domain\r\n  methods\r\n  dataType\r\n  callbackName\r\n  mock\r\n  input\r\n  header\r\n  xhrEvent\r\n  async\r\n  debug\r\n  useMock\r\n  withCredentials\r\n  timeout\r\n  urlModel\r\n  callbackId\r\n  filter\r\n  namespace\r\n  constructor(arg) {\r\n    this.mixins(arg)\r\n  }\r\n  mixins(origin) {\r\n    copyProp(origin, this)\r\n  }\r\n  get href() {\r\n    return this.url + this.search\r\n  }\r\n  get search() {\r\n    let qs = Obj2QueryString(this.filter(this.input))\r\n    return qs ? (queryStringMark(this.url) + qs) : ''\r\n  }\r\n  get url() {\r\n    let { urlModel, domain, namespace } = this\r\n    if (urlModel === 1) {\r\n      return domain\r\n    } else {\r\n      return REGEXP_URL.test(namespace) ? namespace : domain + namespace\r\n    }\r\n  }\r\n  send() {\r\n    if (this.debug) log(`${this.namespace}`, this.input)\r\n    if (this.useMock) {\r\n      return Promise.resolve(this.mock)\r\n    } else if (this.dataType === 'jsonp') {\r\n      return createJsonp(this)\r\n    } else {\r\n      return ajax(this)\r\n    }\r\n  }\r\n}\r\n","import { warn } from './utils/console'\r\nimport { copyProp } from './utils/transform'\r\nimport Entity from './entity'\r\nimport { DEFAULT_OPTIONS } from './constant'\r\nimport { EntityOption, GlobalControl, EntityObject } from './type'\r\n\r\nconst SET: EntityObject = {}\r\nconst COMMON: EntityOption = {}\r\nconst Api: GlobalControl = {\r\n  define(namespace, config = {}) {\r\n    if (SET[namespace]) warn(`redefine ${namespace}`)\r\n    SET[namespace] = new Entity(config)\r\n  },\r\n  config(config = {}) {\r\n    copyProp(config, COMMON)\r\n  },\r\n  require(namespace, data = {}, config = {}) {\r\n    if (!SET[namespace]) this.define(namespace)\r\n    let entity = SET[namespace]\r\n    entity.mixins({\r\n      ...DEFAULT_OPTIONS,\r\n      ...COMMON,\r\n      ...entity,\r\n      ...config,\r\n      namespace,\r\n      input: data\r\n    })\r\n    return entity.send()\r\n  },\r\n  get(namespace) {\r\n    return SET[namespace]\r\n  }\r\n}\r\n\r\nexport default Api\r\n"],"names":["ajax"],"mappings":"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"}